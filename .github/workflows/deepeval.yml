name: DeepEval CI
on:
  push:
    branches: [ main, develop, dev ]
  pull_request:
    branches: [ main, develop, dev ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

jobs:
  deepeval-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 90  # Increased timeout for slow CI runners
    
    strategy:
      fail-fast: false  # Continue other jobs even if one fails
      matrix:
        test-suite: 
          - tests/test_accuracy.py
          - tests/test_hallucination.py
          - tests/test_rag.py
          - tests/test_prompt_regression.py
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'  # Cache pip dependencies
    
    - name: Cache Ollama models
      uses: actions/cache@v4
      with:
        path: ~/.ollama
        key: ollama-llama3-${{ runner.os }}
        restore-keys: |
          ollama-llama3-
    
    - name: Install Ollama
      run: |
        curl -fsSL https://ollama.com/install.sh | sh
        
    - name: Start Ollama service
      run: |
        ollama serve &
        # Wait for Ollama to be ready
        for i in {1..30}; do
          if curl -s http://localhost:11434/api/tags > /dev/null; then
            echo "Ollama is ready!"
            break
          fi
          echo "Waiting for Ollama... ($i/30)"
          sleep 2
        done
        
    - name: Pull and optimize Llama3 model
      run: |
        # Pull smaller quantized model for faster inference in CI
        ollama pull llama3:8b-instruct-q4_0 || ollama pull llama3
        
    - name: Verify model is available
      run: |
        ollama list
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run DeepEval Tests - ${{ matrix.test-suite }}
      env:
        OLLAMA_NUM_PARALLEL: 1  # Limit parallel requests
        OLLAMA_MAX_LOADED_MODELS: 1
      run: |
        pytest ${{ matrix.test-suite }} -v --tb=short
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.test-suite }}
        path: deepeval_results/
        retention-days: 7
